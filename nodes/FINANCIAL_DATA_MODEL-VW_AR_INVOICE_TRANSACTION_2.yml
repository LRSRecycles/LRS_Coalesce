fileVersion: 1
id: 4bd101c9-aecb-4198-8976-b5932e44ae7d
name: VW_AR_INVOICE_TRANSACTION_2
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: FINANCIAL_DATA_MODEL
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: b696b956-c17c-4bd5-923d-a6456a5cd3d0
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: Payment ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: c9525d4c-b31b-49ef-9e66-ae9fcb652987
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: Invoice ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: a72f2b13-69e8-434e-8eb1-b89c81b4e2bc
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: Site_Source
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 9a682600-aa13-4ee5-abef-4f831ddadcb7
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: Source_Customer
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 2fc88f2b-2cae-4438-a365-35438b67f174
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: Source_Customer_Site
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: bbaa652b-6961-4027-bbb6-d8b13e51ab38
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: Invoice Number
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 36f6e991-2705-48e1-ae84-7906afa9bd1f
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: Transaction Type
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: cd0bc432-2b0c-4711-95e6-83d4f82d0e12
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: TIMESTAMP_NTZ(9)
        defaultValue: ""
        description: ""
        name: Transaction Date
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 67816917-6410-4205-9a64-b51e93f0c24e
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: TIMESTAMP_NTZ(9)
        defaultValue: ""
        description: ""
        name: Invoice Date
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: d2ffb9b8-ca2a-4b1a-8147-b94faf0d23f4
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: TIMESTAMP_NTZ(9)
        defaultValue: ""
        description: ""
        name: Due Date
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 77c13bdd-ed6b-439c-9498-fa3498b6cc41
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: NUMBER(38,2)
        defaultValue: ""
        description: ""
        name: Transaction Amount
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 8604e516-c71f-4620-beae-098ec089feaf
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: NUMBER(38,2)
        defaultValue: ""
        description: ""
        name: Invoice Amount
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: e4e11233-b778-4737-bf82-5c89f884a23a
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: NUMBER(1,0)
        defaultValue: ""
        description: ""
        name: Balance
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 8e2aa090-c81d-46e1-b5a7-91e9a304949f
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: TIMESTAMP_NTZ(9)
        defaultValue: ""
        description: ""
        name: Record Date
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 0bc463ac-0f65-4b57-9856-582095bdd46f
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: GL Number
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 3e1841da-b60f-45ae-b530-6d8d24d27e18
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: Group ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: bd007924-f676-4341-9555-fd0a456af757
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: NUMBER(9,0)
        defaultValue: ""
        description: ""
        name: dso_from_due
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 38ff83df-1a4d-42b8-8c0b-cb70f8e86c68
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: NUMBER(9,0)
        defaultValue: ""
        description: ""
        name: dso_from_invoice
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 8c2e7344-6a22-4023-b607-e8398daa484e
          stepCounter: 4bd101c9-aecb-4198-8976-b5932e44ae7d
        config: {}
        dataType: VARCHAR(16777216)
        defaultValue: ""
        description: ""
        name: Source
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
        transform: ""
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('Override Create SQL') }}
            	CREATE OR REPLACE VIEW {{ ref('FINANCIAL_DATA_MODEL', 'VW_AR_INVOICE_TRANSACTION_2')}} AS (
            WITH 
            trux_payments AS (
            SELECT pym."Unique ID" AS "Payment ID"
                 , inv."Unique ID" AS "Invoice ID"
                 --, inv."Customer_Source"
                 , inv."Site Number" AS "Site_Source"
                 , CONCAT(inv.source, '-', "Customer Number") AS "Source_Customer"
                 , CONCAT(inv.source, '-', inv."Customer Number", '-', inv."Site Number") AS "Source_Customer_Site"
                 , inv."Invoice Number" AS "Invoice Number"
                 , CASE 
                     WHEN pym."Payment or Adjustment" = 'P' THEN 'Payment'
                     WHEN pym."Payment or Adjustment" = 'A' THEN 'Adjustment Payment'
                     ELSE NULL 
                   END AS "Transaction Type"
                 , pym."Payment Date" AS "Transaction Date"
                 , inv."Invoice Date" AS "Invoice Date"
                 , inv."Due Date" AS "Due Date"
                 , CASE 
                     WHEN pym."Payment or Adjustment" = 'P' THEN pym."Amount" * -1
                     WHEN pym."Payment or Adjustment" = 'A' THEN pym."Amount"
                     ELSE NULL 
                   END AS "Transaction Amount"
                 , inv."Amount" AS "Invoice Amount"
                 , 0 AS "Balance"
                 , pym."Record Date" AS "Record Date"
                 , pym."GL Number" AS "GL Number"
                 , pym."Group ID" AS "Group ID"
                 , CASE 
                     WHEN pym."Payment or Adjustment" = 'P' THEN DATEDIFF(DAY,inv."Due Date",pym."Payment Date")
                     ELSE NULL 
                   END AS "dso_from_due"
                 , CASE 
                     WHEN pym."Payment or Adjustment" = 'P' THEN DATEDIFF(DAY, inv."Invoice Date",pym."Payment Date")
                     ELSE NULL 
                   END AS "dso_from_invoice"
                 , pym."Source" AS "Source"
              FROM LRS_PRODUCTION.FINANCIAL_DATA_MODEL."AR_Payment_Details" pym
              LEFT JOIN LRS_PRODUCTION.FINANCIAL_DATA_MODEL."AR_Invoice_Amounts" inv
                ON pym."Link_Source" = inv."ID_Source"
             WHERE pym."Source" NOT LIKE '%TOWER%'
            ),
            trux_invoices AS (
            SELECT NULL AS "Payment ID"
                 , "Unique ID" AS "Invoice ID"
                 --,"Customer_Source" AS "Customer_Source"
                 , "Site Number" AS "Site_Source"
                 , CONCAT(source, '-', "Customer Number") AS "Source_Customer"
                 , CONCAT(source, '-', "Customer Number", '-', "Site Number") AS "Source_Customer_Site"
                 , "Invoice Number" AS "Invoice Number"
                 , CASE 
                     WHEN CONTAINS("Invoice Number", 'A') = TRUE THEN 'Invoice Adjustment'
                     WHEN CONTAINS("Invoice Number", 'A') = FALSE THEN 'Invoice'
                     ELSE NULL 
                   END AS "Transaction Type"
                 --, "Due Date" AS "Transaction Date"
                 , "Invoice Date" AS "Transaction Date"
                 , "Invoice Date" AS "Invoice Date"
                 , "Due Date" AS "Due Date"
                 , "Amount" AS "Transaction Amount"
                 , "Amount" AS "Invoice Amount"
                 , 0 AS "Balance"
                 , NULL AS "Record Date"
                 , NULL AS "GL Number"
                 , NULL AS "Group ID"
                 , NULL AS "dso_from_due"
                 , NULL AS "dso_from_invoice"
                 , source AS "Source"
              FROM LRS_PRODUCTION.FINANCIAL_DATA_MODEL."AR_Invoice_Amounts" 
             WHERE source NOT LIKE '%TOWER%'
            ),
            tower_open_balance AS (
            SELECT NULL AS "Payment ID"
                 , a.invoiceuid AS "Invoice ID"
                 --, a.custid AS "Customer_Source"
                 , a.siteid AS "Site_Source"
                 , concat('TOWER_', a.companyid, '-', a.custid) AS "Source_Customer"
                 , concat('TOWER_', a.companyid, '-', a.custid, '-', a.siteid)as "Source_Customer_Site"
                 , b.invoiceid AS "Invoice Number"
                 , 'Open Balance' AS "Transaction Type"
                 , b.invoicedate AS "Transaction Date"
                 , b.invoicedate AS "Invoice Date"
                 , coalesce(a.duedate, b.invoicedate) AS "Due Date"
                 , a.balance AS "Transaction Amount"
                 , a.originalamount AS "Invoice Amount"
                 , 0 AS "Balance"
                 , NULL AS "Record Date"
                 , a.creditacct AS "GL Number"
                 , a.companyid AS "Group ID"
                 , NULL AS "dso_from_due"
                 , NULL AS "dso_from_invoice"
                 , CONCAT('TOWER_', a.companyid) AS "Source"
              FROM LRS_RAW.TOWER_RAW.ARDETAIL a
              LEFT JOIN LRS_RAW.TOWER_RAW.INVOICE b
                ON a.invoiceuid = b.invoiceuid
             WHERE a.balance <> 0
               AND a.status NOT IN (0, 2)
            )
            /*
            tower_open_balance as (
              select
                NULL AS "Payment ID",
                inv."Unique ID" AS "Invoice ID",
                inv."Customer_Source" AS "Customer Source",
                concat(inv.source,inv."Site Number",'-',inv."Customer Number") AS "DB - Site - Cust",
                inv."Invoice Number" AS "Invoice Number",
                'Open Balance' AS "Transaction Type",
                inv."Due Date" AS "Transaction Date",
                inv."Invoice Date" AS "Invoice Date",
                opn.balance AS "Transaction Amount",
                opn.originalamount AS "Invoice Amount",
                0 AS "Balance",
                NULL AS "Record Date",
                NULL AS "GL Number",
                NULL AS "Group ID",
                inv.source AS "Source"
              from
                LRS_DEVELOPMENT.financial_data_model."AR_Invoice_Amounts" inv
              left join
                lrs_raw.tower_raw.customer_vw_open_invoices opn
              on
                inv."Invoice Number" = opn.invoiceid
              where 
                inv.source = 'TOWER'
              and
                opn.billcustid is not NULL
            )
            */

            SELECT * FROM trux_invoices
              
            UNION ALL

            SELECT * FROM trux_payments

            UNION ALL

            SELECT * FROM tower_open_balance
            )
        dependencies: []
        join:
          joinCondition: ""
        name: VW_AR_INVOICE_TRANSACTION_2
        noLinkRefs: []
  name: VW_AR_INVOICE_TRANSACTION_2
  overrideSQL: true
  schema: ""
  sqlType: View
  type: sql
  version: 1
type: Node
